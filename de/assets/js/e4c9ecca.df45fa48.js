"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[6705],{2474:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>h,contentTitle:()=>r,default:()=>u,frontMatter:()=>i,metadata:()=>a,toc:()=>d});var s=n(5893),o=n(1151);const i={sidebar_position:4},r="Unclean shutdowns",a={id:"unraid-os/troubleshooting/unclean-shutdowns",title:"Unclean shutdowns",description:"Sometimes when booting up the system and starting the array a parity check is automatically started due to an unclean shutdown. An unclean shutdown occurs when Unraid records the array was not successfully stopped when the system was last powered off.",source:"@site/docs/unraid-os/troubleshooting/unclean-shutdowns.md",sourceDirName:"unraid-os/troubleshooting",slug:"/unraid-os/troubleshooting/unclean-shutdowns",permalink:"/unraid-docs/de/unraid-os/troubleshooting/unclean-shutdowns",draft:!1,unlisted:!1,editUrl:"https://github.com/unraid/docs/tree/main/docs/unraid-os/troubleshooting/unclean-shutdowns.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{sidebar_position:4},sidebar:"unraidSidebar",previous:{title:"Boot Issues",permalink:"/unraid-docs/de/unraid-os/troubleshooting/boot-issues"},next:{title:"Crash Issues",permalink:"/unraid-docs/de/unraid-os/troubleshooting/system-crash"}},h={},d=[{value:"Events that cause unclean shutdowns",id:"events-that-cause-unclean-shutdowns",level:2},{value:"Unexpected power loss",id:"unexpected-power-loss",level:3},{value:"Flash drive failure",id:"flash-drive-failure",level:3},{value:"Open terminal session",id:"open-terminal-session",level:3},{value:"Configuring timeouts",id:"configuring-timeouts",level:2},{value:"Virtual machines",id:"virtual-machines",level:3},{value:"Docker containers",id:"docker-containers",level:3},{value:"General shutdown timer",id:"general-shutdown-timer",level:3},{value:"UPS battery life",id:"ups-battery-life",level:3},{value:"Recommendations",id:"recommendations",level:2}];function l(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",strong:"strong",ul:"ul",...(0,o.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.h1,{id:"unclean-shutdowns",children:"Unclean shutdowns"}),"\n",(0,s.jsx)(t.p,{children:"Sometimes when booting up the system and starting the array a parity check is automatically started due to an unclean shutdown. An unclean shutdown occurs when Unraid records the array was not successfully stopped when the system was last powered off."}),"\n",(0,s.jsx)(t.h2,{id:"events-that-cause-unclean-shutdowns",children:"Events that cause unclean shutdowns"}),"\n",(0,s.jsx)(t.h3,{id:"unexpected-power-loss",children:"Unexpected power loss"}),"\n",(0,s.jsxs)(t.p,{children:["The best protection against this type of issue is to have an Uninterruptible Power Supply (UPS) that is set up to initiate a controlled shutdown of Unraid initiated by the UPS when the amount of power left in the UPS reaches a trigger level. See ",(0,s.jsx)(t.a,{href:"#configuring-timeouts",children:"Configuring timeouts"})," for the proper configuration of timeouts. Configure these to make sure the system has enough power to perform a graceful shutdown."]}),"\n",(0,s.jsx)(t.admonition,{type:"note",children:(0,s.jsxs)(t.p,{children:["Out of the box, Unraid works with UPS units that support the ",(0,s.jsx)(t.a,{href:"http://www.apcupsd.org/",children:"apcupsd protocol"})," (models from APC and CyberPower typically work well with this). If your particular UPS does not, you can try using the Network UPS Tools (NUT) for Unraid in Community Applications."]})}),"\n",(0,s.jsx)(t.h3,{id:"flash-drive-failure",children:"Flash drive failure"}),"\n",(0,s.jsx)(t.p,{children:"The status of the array is stored on the USB flash device. If, for any reason the status on the flash drive cannot be updated due to the flash drive going offline, or going into a read-only state, then Unraid will not be able to update this status even if the array is stopped successfully. This will be identified as an unclean shutdown the next time you boot the Unraid server."}),"\n",(0,s.jsx)(t.h3,{id:"open-terminal-session",children:"Open terminal session"}),"\n",(0,s.jsx)(t.p,{children:"A common reason for an unclean shutdown is having a terminal session open.\xa0Unraid will not close sessions to shut down, but instead waits for them to be terminated while the shutdown timer is running.\xa0After the overall shutdown timer runs out, the server is forced to shutdown."}),"\n",(0,s.jsx)(t.admonition,{type:"tip",children:(0,s.jsxs)(t.p,{children:["If you have the ",(0,s.jsx)(t.strong,{children:"Dynamix Stop Shell"})," plugin installed, it will add a script to terminate any ",(0,s.jsx)(t.strong,{children:"bash"})," or ",(0,s.jsx)(t.strong,{children:"SSH"})," sessions so Unraid can be gracefully shutdown. However, if there are ongoing write operations to the array."]})}),"\n",(0,s.jsx)(t.h2,{id:"configuring-timeouts",children:"Configuring timeouts"}),"\n",(0,s.jsx)(t.p,{children:"A key part of a clean shutdown is giving enough time for the system processes to finish their workloads. There are various countdowns that are triggered when a shutdown of the array is started. First the system shuts down all VMs, then all containers. Many users find the defaults are too low for their particular workload:"}),"\n",(0,s.jsx)(t.h3,{id:"virtual-machines",children:"Virtual machines"}),"\n",(0,s.jsxs)(t.p,{children:["There is a timer in ",(0,s.jsx)(t.em,{children:(0,s.jsx)(t.strong,{children:"Settings > VM Manager > VM Shutdown"})})," (in ",(0,s.jsx)(t.strong,{children:"Advanced view"}),") that needs to be set to a high enough value to allow your VMs time to completely shutdown. Some factors that impact a VMs shutdown time include the OS' power settings (sleep and hibernation), and any maintenance tasks like Windows Update, on Windows operating systems."]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"Power settings can put the VM into a sleep or hibernation state. A system must resume from this state before initiating shutdown. If you have set up sleep or hibernation on your VM, factor this into your timeout calculations."}),"\n",(0,s.jsxs)(t.li,{children:["Windows VMs will sometimes have an update that requires a reboot of the VM to complete, and will do so by themselves. These can take quite a while and the default setting of 60 seconds in the ",(0,s.jsx)(t.strong,{children:"VM Manager"})," may not be long enough.\xa0If the timer setting is exceeded on a shutdown, your VMs will be forced to shutdown.\xa0This is just like pulling the plug on a PC. A reasonable value is something like 300 seconds (5 minutes) in order to insure your Windows VMs have time to completely shutdown. Alternatively, you can schedule a task to run Windows Update right after system boot, so that it is the first thing that happens, rather than waiting for a system shutdown to trigger it."]}),"\n"]}),"\n",(0,s.jsx)(t.h3,{id:"docker-containers",children:"Docker containers"}),"\n",(0,s.jsxs)(t.p,{children:["There is a configurable timer for stopping Docker containers under\xa0",(0,s.jsx)(t.em,{children:(0,s.jsx)(t.strong,{children:"Settings > Docker"})}),"\xa0(",(0,s.jsx)(t.strong,{children:"in\xa0Advanced view"}),"). When the timer runs out, any running Docker containers will be force-stopped to ensure the system is able to shutdown before the general timer expires. By default, containers are given 10 seconds to stop, but this can be increased if you have complex containers that need more time. Note that containers are stopped in parallel."]}),"\n",(0,s.jsx)(t.h3,{id:"general-shutdown-timer",children:"General shutdown timer"}),"\n",(0,s.jsxs)(t.p,{children:["In order to make sure Unraid shuts down fully before an attached UPS runs out of power, under ",(0,s.jsx)(t.em,{children:(0,s.jsx)(t.strong,{children:"Settings > Disk Settings > Shutdown time-out"})}),", Unraid has a ",(0,s.jsx)(t.strong,{children:"Shutdown time-out"})," setting which has a default value of 90 seconds. All processes that rely on the array or pools must shut down before this timeout expires, or the system will forcibly shutdown on its own, resulting in an unclean shutdown. To ensure the system has time to fully shut down in a worst-case scenario, you can determine the proper ",(0,s.jsx)(t.strong,{children:"Shutdown time-out"})," value for your system by: adding ",(0,s.jsx)(t.code,{children:"3x VM Shutdown timeout"})," + ",(0,s.jsx)(t.code,{children:"Docker stop timeout"})," + another 15 to 30 seconds or more, depending on the speed of your system and how many drives need to be unmounted."]}),"\n",(0,s.jsx)(t.h3,{id:"ups-battery-life",children:"UPS battery life"}),"\n",(0,s.jsxs)(t.p,{children:["Your UPS needs to be of high enough capacity to: detect a power outage, trigger a shutdown, and power the server through the entire \u201cGeneral shutdown timer\u201d. To see roughly how long the UPS can power the system, spin up all disks and navigate to ",(0,s.jsx)(t.em,{children:(0,s.jsx)(t.strong,{children:"Settings > UPS Settings"})})," and review the \u201cRuntime left\u201d. Use the settings on this page to trigger a shutdown with enough time to allow the General shutdown timer to expire before the battery runs out."]}),"\n",(0,s.jsx)(t.h2,{id:"recommendations",children:"Recommendations"}),"\n",(0,s.jsx)(t.p,{children:"These suggested actions can prevent an unclean shutdown, or help determine the cause of one."}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"If your server seems hung and you cannot connect to the WebGUI, try a quick press of the power button. This will initiate a shutdown and Unraid will attempt a graceful shutdown of the server.\xa0If you have to hold the power button to do a hard power off, you will get an unclean shutdown."}),"\n",(0,s.jsxs)(t.li,{children:["You can activate the ",(0,s.jsx)(t.em,{children:(0,s.jsx)(t.strong,{children:"Settings > Syslog Server"})})," to get logs that can survive a reboot as, by default, the syslog is only in RAM and is lost after a reboot. You can find a detailed account of the system diagnostics ",(0,s.jsx)(t.a,{href:"/unraid-docs/de/unraid-os/troubleshooting/diagnostics-information#persistent-logs-syslog-server",children:"here"}),"."]}),"\n",(0,s.jsxs)(t.li,{children:['If an unclean shutdown does occur because the overall "Shutdown time-out" was exceeded, Unraid will attempt to write diagnostics to the ',(0,s.jsx)(t.code,{children:"/log"})," folder on the USB flash device.\xa0When you ask for help in the Unraid forums with an unclean shutdown, attach the ",(0,s.jsx)(t.code,{children:"/log/diagnostics.zip"})," file to your forum post to help the community . There is information in the log that shows why the unclean shutdown occurred."]}),"\n"]})]})}function u(e={}){const{wrapper:t}={...(0,o.a)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},1151:(e,t,n)=>{n.d(t,{Z:()=>a,a:()=>r});var s=n(7294);const o={},i=s.createContext(o);function r(e){const t=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),s.createElement(i.Provider,{value:t},e.children)}}}]);