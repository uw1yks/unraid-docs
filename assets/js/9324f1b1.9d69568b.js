"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[1224],{7938:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>r,default:()=>h,frontMatter:()=>a,metadata:()=>o,toc:()=>l});var i=t(5893),s=t(1151);const a={sidebar_position:7},r="Data Recovery",o={id:"unraid-os/troubleshooting/data-recovery",title:"Data Recovery",description:"THIS SECTION IS STILL UNDER CONSTRUCTION",source:"@site/docs/unraid-os/troubleshooting/data-recovery.md",sourceDirName:"unraid-os/troubleshooting",slug:"/unraid-os/troubleshooting/data-recovery",permalink:"/unraid-os/troubleshooting/data-recovery",draft:!1,unlisted:!1,editUrl:"https://github.com/unraid/docs/tree/main/docs/unraid-os/troubleshooting/data-recovery.md",tags:[],version:"current",sidebarPosition:7,frontMatter:{sidebar_position:7},sidebar:"unraidSidebar",previous:{title:"Windows Connection Issues",permalink:"/unraid-os/troubleshooting/windows-connection"},next:{title:"Docker",permalink:"/unraid-os/troubleshooting/docker"}},d={},l=[{value:"Unmountable Disk(s)",id:"unmountable-disks",level:2},{value:"Lost Array Configuration",id:"lost-array-configuration",level:2},{value:"Using <em>ddrescue</em> to recover data from a failing disk",id:"using-ddrescue-to-recover-data-from-a-failing-disk",level:2}];function c(e){const n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h1,{id:"data-recovery",children:"Data Recovery"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.em,{children:"THIS SECTION IS STILL UNDER CONSTRUCTION"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.em,{children:"A lot more detail still needs to be added"})}),"\n",(0,i.jsx)(n.p,{children:"This section is about recovering your data when Unraid reports problems\nwith one or more drives."}),"\n",(0,i.jsx)(n.p,{children:"There are some important points to bear in mind about securing your\ndata"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Backup critical data:"})," Unraid will protect you against most types\nof simple hardware failure, but not catastrophic failure. You should\n",(0,i.jsx)(n.strong,{children:"ALWAYS"})," have backups of any critical data that you cannot afford\nto lose. Ideally one of those copies should be offsite or on the\ncloud to protect yourself against unforeseen issues such as fire,\ntheft, flood, etc.","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Each user has to make their own determination of what they deem\ncritical and make an assessment of the level of risk they are\nprepared to take."}),"\n",(0,i.jsx)(n.li,{children:"Personal data such as photographs & documents tend to always be\ndeemed critical. Luckily these tend to be relatively small so\neasy to back up."}),"\n",(0,i.jsx)(n.li,{children:"Media files are often deemed non-critical and are relatively\nlarge so a user may well decide these do not merit being backed\nup"}),"\n",(0,i.jsx)(n.li,{children:"Personal video that can never be replaced should fall into the\ncritical category regardless of its size"}),"\n",(0,i.jsxs)(n.li,{children:["Remember that there are things such as ",(0,i.jsx)(n.em,{children:"ransomware"})," around so\nthere should be at least one copy of critical files that cannot\nbe accessed online and corrupted if you are unfortunate enough\nto suffer from such an attack!"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.em,{children:"Be proactive"})," about resolving any issues that are detected by\nUnraid. Make sure that notifications are enabled under\n",(0,i.jsx)(n.em,{children:"Settings->Notifications"})," so that you get told as soon as issues\nare detected. For many users, Unraid operates in a ",(0,i.jsx)(n.em,{children:"fire-and-forget"}),"\nmode so that they will not be actively checking for problems so need\nsuch reminders."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Ask for Advice:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"The Unraid forums have lots of knowledgeable users who can help\nguide you through what needs doing to get your data back into a\nstandard if you are not sure what are the best steps to take."}),"\n",(0,i.jsx)(n.li,{children:"Unraid is very good about protecting your data against typical\nhardware failures, but it is not immune to users taking\ninappropriate steps to recover their data after a failure\noccurs."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"unmountable-disks",children:"Unmountable Disk(s)"}),"\n",(0,i.jsxs)(n.p,{children:["If a disk that was previously mounting fine suddenly starts showing as\n",(0,i.jsx)(n.strong,{children:"unmountable"})," then this normally means that there is some sort of\ncorruption at the file system level. This most commonly occurs after an\nunclean shutdown but could happen any time a write to a drive fails or\nif the drive ends up being marked as 'disabled' (i.e. with a red ','\nin the Unraid GUI)."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"IMPORTANT:"})," At this point, the Unraid GUI will be offering an option\nto format unmountable drives. This will erase all content on the drive\nand update parity to reflect this making recovering the data\nimpossible/very difficult so do ",(0,i.jsx)(n.strong,{children:"NOT"})," do this unless you are happy to\nlose the contents of the drive."]}),"\n",(0,i.jsxs)(n.p,{children:["The correct way to proceed in such a case is to follow the procedure for ",(0,i.jsx)(n.a,{href:"/unraid-os/manual/storage-management#checking-a-file-system",children:"checking and repairing"})," the file system. The vast majority of the time this will repair the disk that was previously showing as unmountable and now it will mount correctly and all your data will be intact. If you are not sure how to proceed then ask a question in the Unraid forums."]}),"\n",(0,i.jsx)(n.h2,{id:"lost-array-configuration",children:"Lost Array Configuration"}),"\n",(0,i.jsx)(n.p,{children:"If you have lost the array configuration and do not have a current\nbackup of the flash device the data will still be intact on the drives."}),"\n",(0,i.jsxs)(n.p,{children:["All configuration information is stored on the flash device in the\n",(0,i.jsx)(n.em,{children:"config"})," folder. In particular, the Unraid array configuration is stored\nin the ",(0,i.jsx)(n.em,{children:"config/super.dat"})," file."]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.em,{children:"Do not attempt to use an out-of-date backup that may have incorrect\ndrive assignments."})}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"If you know which drives were the parity drives then you can simply\nreassign the drives. However, if you do not know which were the parity\ndrives then you have to be more careful as incorrectly assigning a drive\nto parity that is really a data drive will result in you losing its\ncontents."}),"\n",(0,i.jsx)(n.p,{children:"When you do not know which were your parity drives the following steps\ncan get your array back into operation:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Assign all drives as data drives"}),"\n",(0,i.jsx)(n.li,{children:"Start the array"}),"\n",(0,i.jsxs)(n.li,{children:["All the genuine data drives should show as mounted and the parity\ndrive(s) show as ",(0,i.jsx)(n.em,{children:"unmountable"}),". If this is not the case and too many\ndrives show as unmountable then stop and ask for help in the forums\ngiving details of what happened."]}),"\n",(0,i.jsx)(n.li,{children:"Make a note of the serial numbers of the parity drives."}),"\n",(0,i.jsx)(n.li,{children:"Stop the array"}),"\n",(0,i.jsx)(n.li,{children:"Go to Tools->New Config. Select the option to retain current\nassignments (as it reduces the chance of error). Click the yes I\nwant to do this and then Apply."}),"\n",(0,i.jsx)(n.li,{children:"Go back to the Main tab and correct the assignments of the parity\ndrives. Double-check you have the right drives now assigned as\nparity drives as assigning a data drive to parity will lose its\ncontents. You can move any other drives around at this stage as\nwell."}),"\n",(0,i.jsx)(n.li,{children:"Start the array and the system will start building parity based on\nthe current assignments."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"All your User Shares will re-appear (as they are simply the aggregation\nof the top-level folders on each drive) but with default settings, so\nyou may need to re-apply any customization you want."}),"\n",(0,i.jsx)(n.p,{children:"You can now go configure any other customization that is appropriate and\nadd any plugins you normally use."}),"\n",(0,i.jsx)(n.p,{children:"At this point, it is strongly recommended that you click on the flash\ndrive on the Main tab and select the option to download a backup of\nthe flash device. It is always good practice to do this any time you make\na significant change."}),"\n",(0,i.jsxs)(n.h2,{id:"using-ddrescue-to-recover-data-from-a-failing-disk",children:["Using ",(0,i.jsx)(n.em,{children:"ddrescue"})," to recover data from a failing disk"]}),"\n",(0,i.jsxs)(n.p,{children:["In normal use, a tailed/disabled disk is recovered under Unraid using the ",(0,i.jsx)(n.a,{href:"/unraid-os/manual/storage-management#replacing-disks",children:"Replacing Disks"})," procedure."]}),"\n",(0,i.jsxs)(n.p,{children:["Occasionally it can happen due to a variety of reasons, like a disk\nfailing while parity is invalid or two disks failing with single parity,\na user having a failing disk with pending sectors and no way to rebuild\nit using parity, the normal Unraid recovery processes cannot be used. In\nsuch a case you can try using ",(0,i.jsx)(n.strong,{children:"ddrescue"})," to salvage as much data as\npossible."]}),"\n",(0,i.jsxs)(n.p,{children:["To install ",(0,i.jsx)(n.em,{children:"ddrescue"})," install the Nerd Pack plugin then go to Settings\n-> Nerd Pack and install ",(0,i.jsx)(n.em,{children:"ddrescue"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"You need an extra disk (same size or larger than the failing disk) to\nclone the old disk to, using the console/SSH type:"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"ddrescue\xa0-f\xa0/dev/sdX\xa0/dev/sdY\xa0/boot/ddrescue.log"})}),"\n",(0,i.jsx)(n.p,{children:"Both source and destination disks can't be mounted, replace X with\nsource disk, Y with destination disk, always triple-check these, if the\nwrong disk is used as destination it will be overwritten deleting all\ndata."}),"\n",(0,i.jsx)(n.p,{children:"It's also possible to use an array disk as the destination, though only\nif it's the same size as the original, but to maintain parity you can\nonly clone the partition, so the existing array disk needs to be a\nformatted Unraid disk already in any filesystem, still to maintain\nparity you need to use the md# device and the array needs to be started\nin maintenance mode, i.e., not accessible during the copy, by using the\ncommand:"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"ddrescue\xa0-f\xa0/dev/sdX1\xa0/dev/md#\xa0/boot/ddrescue.log"})}),"\n",(0,i.jsx)(n.p,{children:"Replace X with source disk (note the 1 in the source disk identifier), #\nwith destination disk number. It is recommend to enable turbo write\nfirst or it will take much longer."}),"\n",(0,i.jsx)(n.p,{children:"Example output during the 1st pass:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"GNU\xa0ddrescue\xa01.22\nipos:\xa0\xa0926889\xa0MB,\xa0non-trimmed:\xa0\xa0\xa0\xa01695\xa0kB,\xa0\xa0current\xa0rate:\xa0\xa095092\xa0kB/s\nopos:\xa0\xa0926889\xa0MB,\xa0non-scraped:\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa00\xa0B,\xa0\xa0average\xa0rate:\xa0\xa079236\xa0kB/s\nnon-tried:\xa0\xa0\xa0\xa01074\xa0GB,\xa0\xa0bad-sector:\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa00\xa0B,\xa0\xa0\xa0\xa0error\xa0rate:\xa0\xa0\xa0\xa0\xa0\xa0\xa00\xa0B/s\nrescued:\xa0\xa0925804\xa0MB,\xa0\xa0\xa0bad\xa0areas:\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa00,\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0run\xa0time:\xa0\xa03h\xa014m\xa044s\npct\xa0rescued:\xa0\xa0\xa046.28%,\xa0read\xa0errors:\xa0\xa0\xa0\xa0\xa0\xa0\xa054,\xa0\xa0remaining\xa0time:\xa0\xa0\xa0\xa0\xa0\xa03h\xa018m\ntime\xa0since\xa0last\xa0successful\xa0read:\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa00s\nCopying\xa0non-tried\xa0blocks...\xa0Pass\xa01\xa0(forwards)\n"})}),"\n",(0,i.jsx)(n.p,{children:"After copying all the good blocks ddrescue will retry the bad blocks,\nforwards and backwards, this last part can take some time depending on\nhow bad the disk is, example:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"GNU\xa0ddrescue\xa01.22\nipos:\xa0\xa0\xa017878\xa0MB,\xa0non-trimmed:\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa00\xa0B,\xa0\xa0current\xa0rate:\xa0\xa0\xa0\xa0\xa0\xa0\xa00\xa0B/s\nopos:\xa0\xa0\xa017878\xa0MB,\xa0non-scraped:\xa0\xa0\xa0362496\xa0B,\xa0\xa0average\xa0rate:\xa0\xa074898\xa0kB/s\nnon-tried:\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa00\xa0B,\xa0\xa0bad-sector:\xa0\xa0\xa0\xa093696\xa0B,\xa0\xa0\xa0\xa0error\xa0rate:\xa0\xa0\xa0\xa0\xa0102\xa0B/s\nrescued:\xa0\xa0\xa0\xa02000\xa0GB,\xa0\xa0\xa0bad\xa0areas:\xa0\xa0\xa0\xa0\xa0\xa0101,\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0run\xa0time:\xa0\xa07h\xa025m\xa0\xa08s\npct\xa0rescued:\xa0\xa0\xa099.99%,\xa0read\xa0errors:\xa0\xa0\xa0\xa0\xa0\xa0260,\xa0\xa0remaining\xa0time:\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa025m\ntime\xa0since\xa0last\xa0successful\xa0read:\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa010s\nScraping\xa0failed\xa0blocks...\xa0(forwards)\n"})}),"\n",(0,i.jsx)(n.p,{children:"After the clone is complete you can mount the destination disk manually\nor using for example the UD plugin (if the cloned disk is unmountable\nrun the appropriate filesystem repair tool, it might also be a good idea\nto run a filesystem check even if it mounts OK) and copy the recovered\ndata to the array. Some files will likely be corrupt and if you have\nchecksums or are using BTRFS you can easily find out which ones. If not\nsee below."}),"\n",(0,i.jsx)(n.p,{children:"If you don't have checksums for your files (or use btrfs) there's a\nway you can still check which files were affected:"}),"\n",(0,i.jsx)(n.p,{children:"Create a temporary text file with a text string not present on your\ndata, e.g.:"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:'printf\xa0"Unraid\xa0"\xa0>~/fill.txt'})}),"\n",(0,i.jsx)(n.p,{children:"Then fill the bad blocks on the destination disk with that string:"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"ddrescue\xa0-f\xa0--fill=-\xa0~/fill.txt\xa0/dev/sdY\xa0/boot/ddrescue.log"})}),"\n",(0,i.jsx)(n.p,{children:"Replace Y with the cloned disk (not the original) and use the existing\nddrescue mapfile."}),"\n",(0,i.jsx)(n.p,{children:"Finally mount the disk, manually or for example using the UD plugin and\nsearch for that string:"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"find\xa0/mnt/path/to/disk\xa0-type\xa0f\xa0-exec\xa0grep\xa0-l\xa0\"Unraid\"\xa0'{}'\xa0';'"})}),"\n",(0,i.jsx)(n.p,{children:'Replace /path/to/disk with the correct mount point, all files containing\nthe string "Unraid" will be output and those are your corrupt files,\nthis will take some time as all files on the disks will be scanned, the\noutput is only displayed in the end, and if there\'s no output then the\nbad sectors were in areas without any files.'})]})}function h(e={}){const{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},1151:(e,n,t)=>{t.d(n,{Z:()=>o,a:()=>r});var i=t(7294);const s={},a=i.createContext(s);function r(e){const n=i.useContext(a);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),i.createElement(a.Provider,{value:n},e.children)}}}]);